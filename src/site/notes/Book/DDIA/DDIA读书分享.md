---
{"dg-publish":true,"dg-permalink":"/DDIA读书分享","permalink":"/DDIA读书分享/"}
---


# 为什么要读DDIA

- DDIA的中文翻译叫 *<<设计数据密集型应用>>*，我们后端开发大部分时间都是在开发数据密集型应用，这部分内容跟工作关联度非常高
- 算是比较权威的书，比网上零散的文章更加系统
- 对redis、zk这些分布式中间件的通用原理能有更深层次的理解，从更全局的视角看待问题

## 缺点

讲原理不讲细节，想更深入理解的话，这本书没有给出答案，不过个人感觉对我们业务开发来说足够了，对中间件开发来说可能只能算入门

# 分享内容

第一章讲的是单机数据库系统的设计，印象比较深的是一个SSTable的实现思路，因为跟我们工作内容相关性没那么多，所以这部分不分享了，主要分享内容以后半部分的分布式一致性为主

## CAP

网上大部分的对CAP定理的说法是:

> CAP原则又称CAP定理，**指的是在一个分布式系统中，一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance）**。 CAP 原则指的是，这三个要素最多只能同时实现两点，不可能三者兼顾

这个解释方式反正我第一次接触的时候是没看懂的，只是说了结论，没说原因，并且感觉网上大部分文章其实都没讲明白，这本书里感觉定义就非常清楚，并且明确的把CAP说成了 *没有帮助*:

> CAP 有时以这种面目出现：一致性，可用性和分区容错性：三者只能择其二。不幸的是这种说法很有误导性，因为网络分区是一种故障类型，所以它并不是一个选项：不管你喜不喜欢它都会发生。
> 
> 在网络正常工作的时候，系统可以提供一致性（线性一致性）和整体可用性。发生网络故障时，你必须在线性一致性和整体可用性之间做出选择。因此，CAP 更好的表述成：在分区时要么选择一致，要么选择可用。一个更可靠的网络需要减少这个选择，但是在某些时候选择是不可避免的。
> 
> 在 CAP 的讨论中，术语可用性有几个相互矛盾的定义，形式化作为一个定理并不符合其通常的含义。许多所谓的 “高可用”（容错）系统实际上不符合 CAP 对可用性的特殊定义。总而言之，围绕着 CAP 有很多误解和困惑，并不能帮助我们更好地理解系统，所以最好避免使用 CAP

说白了就是系统发生分区，并不是一个选项，它是一个分布式系统长时间运行后，必然会发生的一个 *故障*，在这种故障发生后，CP跟AP只能选择一种

### 为什么CP跟AP不可兼得

#### 从单机系统开始演进

假如系统目前只有一台单机数据库A:

<style>
.container {font-family: sans-serif; text-align: center;}
.button-wrapper button {z-index: 1;height: 40px; width: 100px; margin: 10px;padding: 5px;}
.excalidraw .App-menu_top .buttonList { display: flex;}
.excalidraw-wrapper { height: 800px; margin: 50px; position: relative;}
:root[dir="ltr"] .excalidraw .layer-ui__wrapper .zen-mode-transition.App-menu_bottom--transition-left {transform: none;}
</style><script src="https://unpkg.com/react@17/umd/react.production.min.js"></script><script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script><script type="text/javascript" src="https://unpkg.com/@excalidraw/excalidraw@0.12.0/dist/excalidraw.production.min.js"></script><div id="DDIA分享-01excalidraw.md1"></div><script>(function(){const InitialData={"type":"excalidraw","version":2,"source":"https://excalidraw.com","elements":[{"id":"vUx56GAEK-P9OzWnAnCsI","type":"ellipse","x":-73.09375,"y":-225.79296875,"width":80,"height":78,"angle":0,"strokeColor":"#000000","backgroundColor":"#fab005","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"sharp","seed":1674145458,"version":121,"versionNonce":1983223474,"isDeleted":false,"boundElements":[{"type":"text","id":"M5xZlP4j"}],"updated":1670943270415,"link":null,"locked":false},{"id":"M5xZlP4j","type":"text","x":-40.59375,"y":-199.29296875,"width":15,"height":25,"angle":0,"strokeColor":"#000000","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"sharp","seed":1364853490,"version":46,"versionNonce":1654252910,"isDeleted":false,"boundElements":null,"updated":1670943270415,"link":null,"locked":false,"text":"A","rawText":"A","fontSize":20,"fontFamily":1,"textAlign":"center","verticalAlign":"middle","baseline":18,"containerId":"vUx56GAEK-P9OzWnAnCsI","originalText":"A"}],"appState":{"theme":"light","viewBackgroundColor":"#ffffff","currentItemStrokeColor":"#000000","currentItemBackgroundColor":"#fab005","currentItemFillStyle":"hachure","currentItemStrokeWidth":1,"currentItemStrokeStyle":"solid","currentItemRoughness":1,"currentItemOpacity":100,"currentItemFontFamily":1,"currentItemFontSize":20,"currentItemTextAlign":"left","currentItemStrokeSharpness":"sharp","currentItemStartArrowhead":null,"currentItemEndArrowhead":"arrow","currentItemLinearStrokeSharpness":"round","gridSize":null,"colorPalette":{}},"files":{}};InitialData.scrollToContent=true;App=()=>{const e=React.useRef(null),t=React.useRef(null),[n,i]=React.useState({width:void 0,height:void 0});return React.useEffect(()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height});const e=()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height})};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[t]),React.createElement(React.Fragment,null,React.createElement("div",{className:"excalidraw-wrapper",ref:t},React.createElement(ExcalidrawLib.Excalidraw,{ref:e,width:n.width,height:n.height,initialData:InitialData,viewModeEnabled:!0,zenModeEnabled:!0,gridModeEnabled:!1})))},excalidrawWrapper=document.getElementById("DDIA分享-01excalidraw.md1");ReactDOM.render(React.createElement(App),excalidrawWrapper);})();</script>

只要服务不发生故障，那可以理解为它是一直可用的，但是服务总会有故障的那一天，因为只有单机，所以一旦故障了就会造成损失，为了防止A故障服务不可用，就必然需要引入多台机器，组成集群，比如加了一台B

#### 增加机器(节点)数量

假如加入了一台机器B，作为备份:

<div id="DDIA分享-02excalidraw.md2"></div><script>(function(){const InitialData={"type":"excalidraw","version":2,"source":"https://excalidraw.com","elements":[{"type":"ellipse","version":123,"versionNonce":898359022,"isDeleted":false,"id":"hgtB4-9-lvKOE-VgGPeVs","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-143,"y":-131.609375,"strokeColor":"#000000","backgroundColor":"#fab005","width":80,"height":78,"seed":1926963822,"groupIds":[],"strokeSharpness":"sharp","boundElements":[{"id":"0qejQ8RJ","type":"text"}],"updated":1670943556747,"link":null,"locked":false},{"type":"text","version":47,"versionNonce":929285426,"isDeleted":false,"id":"0qejQ8RJ","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-110.5,"y":-105.109375,"strokeColor":"#000000","backgroundColor":"transparent","width":15,"height":25,"seed":363922290,"groupIds":[],"strokeSharpness":"sharp","boundElements":[],"updated":1670943556747,"link":null,"locked":false,"fontSize":20,"fontFamily":1,"text":"A","rawText":"A","baseline":18,"textAlign":"center","verticalAlign":"middle","containerId":"hgtB4-9-lvKOE-VgGPeVs","originalText":"A"},{"type":"ellipse","version":232,"versionNonce":1360461550,"isDeleted":false,"id":"teNLPZQ0A5JzD2C5qCAdU","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":3.279296875,"y":-133.10546875,"strokeColor":"#000000","backgroundColor":"#82c91e","width":80,"height":78,"seed":852349230,"groupIds":[],"strokeSharpness":"sharp","boundElements":[{"id":"8bpU9W1m","type":"text"}],"updated":1670943775950,"link":null,"locked":false},{"type":"text","version":156,"versionNonce":789524210,"isDeleted":false,"id":"8bpU9W1m","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":34.779296875,"y":-106.60546875,"strokeColor":"#000000","backgroundColor":"transparent","width":17,"height":25,"seed":110469298,"groupIds":[],"strokeSharpness":"sharp","boundElements":[],"updated":1670943775950,"link":null,"locked":false,"fontSize":20,"fontFamily":1,"text":"B","rawText":"B","baseline":18,"textAlign":"center","verticalAlign":"middle","containerId":"teNLPZQ0A5JzD2C5qCAdU","originalText":"B"}],"appState":{"theme":"light","viewBackgroundColor":"#ffffff","currentItemStrokeColor":"#000000","currentItemBackgroundColor":"#82c91e","currentItemFillStyle":"hachure","currentItemStrokeWidth":1,"currentItemStrokeStyle":"solid","currentItemRoughness":1,"currentItemOpacity":100,"currentItemFontFamily":1,"currentItemFontSize":20,"currentItemTextAlign":"left","currentItemStrokeSharpness":"sharp","currentItemStartArrowhead":null,"currentItemEndArrowhead":"arrow","currentItemLinearStrokeSharpness":"round","gridSize":null,"colorPalette":{}},"files":{}};InitialData.scrollToContent=true;App=()=>{const e=React.useRef(null),t=React.useRef(null),[n,i]=React.useState({width:void 0,height:void 0});return React.useEffect(()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height});const e=()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height})};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[t]),React.createElement(React.Fragment,null,React.createElement("div",{className:"excalidraw-wrapper",ref:t},React.createElement(ExcalidrawLib.Excalidraw,{ref:e,width:n.width,height:n.height,initialData:InitialData,viewModeEnabled:!0,zenModeEnabled:!0,gridModeEnabled:!1})))},excalidrawWrapper=document.getElementById("DDIA分享-02excalidraw.md2");ReactDOM.render(React.createElement(App),excalidrawWrapper);})();</script>

这个时候第一个问题来了，两台数据库服务器，他们怎么交互?

想想Mysql，一主一备，那是否可以让B成为A的备份，从A那里同步数据，假如按这个思路，A就成了主库，B成了从库，书里对这种方式叫 **复制**，这种架构叫 **单主复制** :

<div id="DDIA分享-03excalidraw.md3"></div><script>(function(){const InitialData={"type":"excalidraw","version":2,"source":"https://excalidraw.com","elements":[{"type":"ellipse","version":166,"versionNonce":814318898,"isDeleted":false,"id":"Lht3WEqRHTBjAadoPyhkd","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-111.3154296875,"y":-131.861328125,"strokeColor":"#000000","backgroundColor":"#fab005","width":80,"height":78,"seed":1539931186,"groupIds":[],"strokeSharpness":"sharp","boundElements":[{"id":"B9btEa4D","type":"text"},{"id":"Uu-O2lLzhcJwUfgh_sLb4","type":"arrow"}],"updated":1670943797518,"link":null,"locked":false},{"type":"text","version":88,"versionNonce":446832366,"isDeleted":false,"id":"B9btEa4D","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-78.8154296875,"y":-105.361328125,"strokeColor":"#000000","backgroundColor":"transparent","width":15,"height":25,"seed":1019287534,"groupIds":[],"strokeSharpness":"sharp","boundElements":[],"updated":1670943797518,"link":null,"locked":false,"fontSize":20,"fontFamily":1,"text":"A","rawText":"A","baseline":18,"textAlign":"center","verticalAlign":"middle","containerId":"Lht3WEqRHTBjAadoPyhkd","originalText":"A"},{"type":"ellipse","version":255,"versionNonce":913704946,"isDeleted":false,"id":"nIdXcCVbMsrRF25wGBstc","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":68.7529296875,"y":-131.255859375,"strokeColor":"#000000","backgroundColor":"#82c91e","width":80,"height":78,"seed":1030694386,"groupIds":[],"strokeSharpness":"sharp","boundElements":[{"id":"rm0JameQ","type":"text"},{"id":"Uu-O2lLzhcJwUfgh_sLb4","type":"arrow"}],"updated":1670943808849,"link":null,"locked":false},{"type":"text","version":177,"versionNonce":432285742,"isDeleted":false,"id":"rm0JameQ","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":100.2529296875,"y":-104.755859375,"strokeColor":"#000000","backgroundColor":"transparent","width":17,"height":25,"seed":1895033390,"groupIds":[],"strokeSharpness":"sharp","boundElements":[],"updated":1670943808849,"link":null,"locked":false,"fontSize":20,"fontFamily":1,"text":"B","rawText":"B","baseline":18,"textAlign":"center","verticalAlign":"middle","containerId":"nIdXcCVbMsrRF25wGBstc","originalText":"B"},{"id":"Uu-O2lLzhcJwUfgh_sLb4","type":"arrow","x":-24.946057801942423,"y":-92.71792791600382,"width":89.22120621316077,"height":0.22940759502593266,"angle":0,"strokeColor":"#000000","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"round","seed":1915642670,"version":197,"versionNonce":329970286,"isDeleted":false,"boundElements":null,"updated":1670943808849,"link":null,"locked":false,"points":[[0,0],[89.22120621316077,-0.22940759502593266]],"lastCommittedPoint":null,"startBinding":{"elementId":"Lht3WEqRHTBjAadoPyhkd","focus":0.006788289082259551,"gap":6.369603504498876},"endBinding":{"elementId":"nIdXcCVbMsrRF25wGBstc","focus":0.02066245171581273,"gap":4.483406020516547},"startArrowhead":null,"endArrowhead":"arrow"},{"id":"xCpfE4dR","type":"text","x":-9.94140625,"y":-132.99609375,"width":42,"height":22,"angle":0,"strokeColor":"#000000","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"sharp","seed":1095458994,"version":50,"versionNonce":1481262,"isDeleted":false,"boundElements":null,"updated":1670943810184,"link":null,"locked":false,"text":"复制","rawText":"复制","fontSize":20,"fontFamily":4,"textAlign":"left","verticalAlign":"top","baseline":18,"containerId":null,"originalText":"复制"}],"appState":{"theme":"light","viewBackgroundColor":"#ffffff","currentItemStrokeColor":"#000000","currentItemBackgroundColor":"transparent","currentItemFillStyle":"hachure","currentItemStrokeWidth":1,"currentItemStrokeStyle":"solid","currentItemRoughness":1,"currentItemOpacity":100,"currentItemFontFamily":4,"currentItemFontSize":20,"currentItemTextAlign":"left","currentItemStrokeSharpness":"sharp","currentItemStartArrowhead":null,"currentItemEndArrowhead":"arrow","currentItemLinearStrokeSharpness":"round","gridSize":null,"colorPalette":{}},"files":{}};InitialData.scrollToContent=true;App=()=>{const e=React.useRef(null),t=React.useRef(null),[n,i]=React.useState({width:void 0,height:void 0});return React.useEffect(()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height});const e=()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height})};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[t]),React.createElement(React.Fragment,null,React.createElement("div",{className:"excalidraw-wrapper",ref:t},React.createElement(ExcalidrawLib.Excalidraw,{ref:e,width:n.width,height:n.height,initialData:InitialData,viewModeEnabled:!0,zenModeEnabled:!0,gridModeEnabled:!1})))},excalidrawWrapper=document.getElementById("DDIA分享-03excalidraw.md3");ReactDOM.render(React.createElement(App),excalidrawWrapper);})();</script>

#### 发生分区

这个简单的例子里面，假如对A写入了某个数据之后，还没有同步给B时A挂了，那接下来只有两种方案
1. 让请求继续访问B读取数据，但是B里面有一些数据是在A挂了之后还没有及时同步的，也就是虽然B继续提供服务保证集群容错，满足了可用性，但是存在数据不一致
2. 整体拒绝服务，等A恢复后，把数据同步给了B，再提供服务，这样可以保证数据一致，但是系统无法高可用

### 是不是真的只能二选一

CAP里的C指的是 **线性一致性**，也就是说如果在系统发生分区的情况下，确实线性一致性跟高可用是只能二选一的，但是现实情况，大部分场景下我们都不需要线性一致性这种强一致性保证，所以经过一定的取舍，实际的系统实现上，往往看起来 **一致性(非线性一致性)** 跟高可用是可以兼得的，这个也是刚学概念的时候非常困惑的一点

## 复制 VS 分区

### 复制

前面提到了为了保证集群具备一定的容错能力，可以加机器，通过复制的方式，来达到高可用

也就是说复制，主要就是为了解决服务的容错能力

### 分区

复制解决了服务的高可用问题，但是并没有实际提高服务的存储能力(容量)，也就是说假如只有复制，那加机器只是让集群完全挂掉的可能性降低了，实际容量还是一样的

复制是每台机器都保留相同的副本，分区则是每台机器存储一部分数据，实际应用的架构是两种结合的，因为如果只有分区，则服务的容量可以随着机器数增加而增加，但是假如某台机器挂了，那部分数据就丢失了，所以大的架构上是先分区，小集群再做复制

<div id="DDIA分享-04excalidraw.md4"></div><script>(function(){const InitialData={"type":"excalidraw","version":2,"source":"https://excalidraw.com","elements":[{"type":"rectangle","version":95,"versionNonce":1862441388,"isDeleted":false,"id":"es3Z0_Qs7U0wavlhOXbIe","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-193.265625,"y":-223.6171875,"strokeColor":"#000000","backgroundColor":"transparent","width":132.375,"height":242.8515625,"seed":1467284524,"groupIds":[],"strokeSharpness":"sharp","boundElements":[],"updated":1671026825410,"link":null,"locked":false},{"type":"ellipse","version":89,"versionNonce":1937985684,"isDeleted":false,"id":"Kk2JhK59lJiVlE_Ez-9I3","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-163.26453993055554,"y":-196.54296875,"strokeColor":"#000000","backgroundColor":"#fab005","width":65,"height":64,"seed":749870380,"groupIds":[],"strokeSharpness":"sharp","boundElements":[{"type":"text","id":"zJ8bBYyS"},{"id":"GxCYX4pDZ7UzGKGmSygHY","type":"arrow"}],"updated":1671026827302,"link":null,"locked":false},{"type":"text","version":21,"versionNonce":1431995436,"isDeleted":false,"id":"zJ8bBYyS","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-138.26453993055554,"y":-177.04296875,"strokeColor":"#000000","backgroundColor":"transparent","width":15,"height":25,"seed":1384518188,"groupIds":[],"strokeSharpness":"sharp","boundElements":[],"updated":1671026825410,"link":null,"locked":false,"fontSize":20,"fontFamily":1,"text":"A","rawText":"A","baseline":18,"textAlign":"center","verticalAlign":"middle","containerId":"Kk2JhK59lJiVlE_Ez-9I3","originalText":"A"},{"type":"ellipse","version":132,"versionNonce":292822548,"isDeleted":false,"id":"CgWdqFOX4HBVo96_ztG6l","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-163.16796875,"y":-79.6484375,"strokeColor":"#000000","backgroundColor":"#fab005","width":65,"height":64,"seed":1752215980,"groupIds":[],"strokeSharpness":"sharp","boundElements":[{"id":"TP6Fp1NI","type":"text"},{"id":"GxCYX4pDZ7UzGKGmSygHY","type":"arrow"}],"updated":1671026830417,"link":null,"locked":false},{"type":"text","version":64,"versionNonce":777068204,"isDeleted":false,"id":"TP6Fp1NI","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-141.16796875,"y":-60.1484375,"strokeColor":"#000000","backgroundColor":"transparent","width":21,"height":25,"seed":426610452,"groupIds":[],"strokeSharpness":"sharp","boundElements":[],"updated":1671026825411,"link":null,"locked":false,"fontSize":20,"fontFamily":1,"text":"A'","rawText":"A'","baseline":18,"textAlign":"center","verticalAlign":"middle","containerId":"CgWdqFOX4HBVo96_ztG6l","originalText":"A'"},{"type":"rectangle","version":188,"versionNonce":1909879316,"isDeleted":false,"id":"XP3bqnDezOGCXZO4IzT-E","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":68.6171875,"y":-219.75390625,"strokeColor":"#000000","backgroundColor":"transparent","width":132.375,"height":242.8515625,"seed":107623852,"groupIds":[],"strokeSharpness":"sharp","boundElements":[],"updated":1671026825411,"link":null,"locked":false},{"type":"ellipse","version":220,"versionNonce":586103700,"isDeleted":false,"id":"AQbVVLASoPnLbelYF7TRU","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":98.548828125,"y":-192.6796875,"strokeColor":"#000000","backgroundColor":"#15aabf","width":65,"height":64,"seed":348015380,"groupIds":[],"strokeSharpness":"sharp","boundElements":[{"id":"BLKTD0n4","type":"text"},{"id":"rJF4wal8ygYp5k9kqDc0b","type":"arrow"}],"updated":1671026833750,"link":null,"locked":false},{"type":"text","version":152,"versionNonce":1810304916,"isDeleted":false,"id":"BLKTD0n4","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":122.548828125,"y":-173.1796875,"strokeColor":"#000000","backgroundColor":"transparent","width":17,"height":25,"seed":1433313324,"groupIds":[],"strokeSharpness":"sharp","boundElements":[],"updated":1671026825411,"link":null,"locked":false,"fontSize":20,"fontFamily":1,"text":"B","rawText":"B","baseline":18,"textAlign":"center","verticalAlign":"middle","containerId":"AQbVVLASoPnLbelYF7TRU","originalText":"B"},{"type":"ellipse","version":266,"versionNonce":1646962964,"isDeleted":false,"id":"T-EpiNB72gvFA5jIUFEgk","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":98.83984375,"y":-75.78515625,"strokeColor":"#000000","backgroundColor":"#15aabf","width":65,"height":64,"seed":1986775188,"groupIds":[],"strokeSharpness":"sharp","boundElements":[{"id":"AJ9srLzc","type":"text"},{"id":"rJF4wal8ygYp5k9kqDc0b","type":"arrow"}],"updated":1671026837616,"link":null,"locked":false},{"type":"text","version":199,"versionNonce":1695022356,"isDeleted":false,"id":"AJ9srLzc","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":120.33984375,"y":-56.28515625,"strokeColor":"#000000","backgroundColor":"transparent","width":22,"height":25,"seed":1300347564,"groupIds":[],"strokeSharpness":"sharp","boundElements":[],"updated":1671026825411,"link":null,"locked":false,"fontSize":20,"fontFamily":1,"text":"B'","rawText":"B'","baseline":18,"textAlign":"center","verticalAlign":"middle","containerId":"T-EpiNB72gvFA5jIUFEgk","originalText":"B'"},{"type":"line","version":65,"versionNonce":1297157676,"isDeleted":false,"id":"66p7d4uJvr5EYU662Az8y","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"dashed","roughness":1,"opacity":100,"angle":0,"x":-121.47352430555557,"y":-226.78602430555554,"strokeColor":"#000000","backgroundColor":"transparent","width":115.59765625,"height":129.03515625,"seed":78541996,"groupIds":[],"strokeSharpness":"round","boundElements":[],"updated":1671026825411,"link":null,"locked":false,"startBinding":null,"endBinding":null,"lastCommittedPoint":null,"startArrowhead":null,"endArrowhead":null,"points":[[0,0],[115.59765625,-129.03515625]]},{"type":"line","version":100,"versionNonce":917453460,"isDeleted":false,"id":"DHzEmd5-hwVTXWaCoyaZ0","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"dashed","roughness":1,"opacity":100,"angle":0,"x":-4.625,"y":-355.89453125,"strokeColor":"#000000","backgroundColor":"transparent","width":131.20703125,"height":135.4609375,"seed":411125036,"groupIds":[],"strokeSharpness":"round","boundElements":[],"updated":1671026825411,"link":null,"locked":false,"startBinding":null,"endBinding":null,"lastCommittedPoint":null,"startArrowhead":null,"endArrowhead":null,"points":[[0,0],[131.20703125,135.4609375]]},{"type":"text","version":151,"versionNonce":906899220,"isDeleted":false,"id":"8TqeEkTF","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-83.65500351758664,"y":-393.0413517761663,"strokeColor":"#000000","backgroundColor":"transparent","width":172,"height":24,"seed":253460,"groupIds":[],"strokeSharpness":"sharp","boundElements":[],"updated":1671026852171,"link":null,"locked":false,"fontSize":21.87223800505051,"fontFamily":4,"text":"举例: 按范围分区","rawText":"举例: 按范围分区","baseline":20,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"举例: 按范围分区"},{"id":"EFL8DMgk","type":"text","x":-161.6640625,"y":-309.802517361111,"width":81,"height":22,"angle":0,"strokeColor":"#2b8a3e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"dashed","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"sharp","seed":670510740,"version":59,"versionNonce":462604308,"isDeleted":false,"boundElements":null,"updated":1671026825411,"link":null,"locked":false,"text":"(0 - 100)","rawText":"(0 - 100)","fontSize":20,"fontFamily":4,"textAlign":"left","verticalAlign":"top","baseline":18,"containerId":null,"originalText":"(0 - 100)"},{"type":"text","version":135,"versionNonce":837579564,"isDeleted":false,"id":"Q0V7KiPA","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"dashed","roughness":1,"opacity":100,"angle":0,"x":69.07291666666654,"y":-316.4661458333332,"strokeColor":"#2b8a3e","backgroundColor":"transparent","width":100,"height":22,"seed":746100244,"groupIds":[],"strokeSharpness":"sharp","boundElements":[],"updated":1671026825411,"link":null,"locked":false,"fontSize":20,"fontFamily":4,"text":"(100 - 200)","rawText":"(100 - 200)","baseline":18,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"(100 - 200)"},{"id":"GxCYX4pDZ7UzGKGmSygHY","type":"arrow","x":-131.93034290397662,"y":-130.46061098177444,"width":0.4015942110518722,"height":45.50149765996176,"angle":0,"strokeColor":"#2b8a3e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"dashed","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"round","seed":70247340,"version":114,"versionNonce":128492948,"isDeleted":false,"boundElements":null,"updated":1671026825411,"link":null,"locked":false,"points":[[0,0],[-0.4015942110518722,45.50149765996176]],"lastCommittedPoint":null,"startBinding":{"elementId":"Kk2JhK59lJiVlE_Ez-9I3","focus":0.026201973645716366,"gap":2.1017186239347723},"endBinding":{"elementId":"CgWdqFOX4HBVo96_ztG6l","focus":-0.06132909178899008,"gap":5.3467889700542415},"startArrowhead":null,"endArrowhead":"arrow"},{"type":"arrow","version":182,"versionNonce":550317484,"isDeleted":false,"id":"rJF4wal8ygYp5k9kqDc0b","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"dashed","roughness":1,"opacity":100,"angle":0,"x":130.63230541978544,"y":-124.500138599508,"strokeColor":"#2b8a3e","backgroundColor":"transparent","width":0.37977430555557135,"height":45.5013020833334,"seed":2035590676,"groupIds":[],"strokeSharpness":"round","boundElements":[],"updated":1671026825411,"link":null,"locked":false,"startBinding":{"elementId":"AQbVVLASoPnLbelYF7TRU","focus":0.003524556027098195,"gap":4.181881492379816},"endBinding":{"elementId":"T-EpiNB72gvFA5jIUFEgk","focus":-0.04249769814576015,"gap":3.2299964102373764},"lastCommittedPoint":null,"startArrowhead":null,"endArrowhead":"arrow","points":[[0,0],[-0.37977430555557135,45.5013020833334]]},{"id":"w0WCHnxm","type":"text","x":-180.65060763888846,"y":-118.84114583333303,"width":42,"height":22,"angle":0,"strokeColor":"#000000","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"dashed","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"sharp","seed":2088620076,"version":43,"versionNonce":2544404,"isDeleted":false,"boundElements":null,"updated":1671026825411,"link":null,"locked":false,"text":"复制","rawText":"复制","fontSize":20,"fontFamily":4,"textAlign":"left","verticalAlign":"top","baseline":18,"containerId":null,"originalText":"复制"},{"type":"text","version":130,"versionNonce":414357548,"isDeleted":false,"id":"gucnPqlo","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"dashed","roughness":1,"opacity":100,"angle":0,"x":81.9995659722226,"y":-115.69574652777743,"strokeColor":"#000000","backgroundColor":"transparent","width":42,"height":22,"seed":304932652,"groupIds":[],"strokeSharpness":"sharp","boundElements":[],"updated":1671026825411,"link":null,"locked":false,"fontSize":20,"fontFamily":4,"text":"复制","rawText":"复制","baseline":18,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"复制"}],"appState":{"theme":"light","viewBackgroundColor":"#ffffff","currentItemStrokeColor":"#000000","currentItemBackgroundColor":"#15aabf","currentItemFillStyle":"hachure","currentItemStrokeWidth":1,"currentItemStrokeStyle":"dashed","currentItemRoughness":1,"currentItemOpacity":100,"currentItemFontFamily":4,"currentItemFontSize":20,"currentItemTextAlign":"left","currentItemStrokeSharpness":"sharp","currentItemStartArrowhead":null,"currentItemEndArrowhead":"arrow","currentItemLinearStrokeSharpness":"round","gridSize":null,"colorPalette":{}},"files":{}};InitialData.scrollToContent=true;App=()=>{const e=React.useRef(null),t=React.useRef(null),[n,i]=React.useState({width:void 0,height:void 0});return React.useEffect(()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height});const e=()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height})};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[t]),React.createElement(React.Fragment,null,React.createElement("div",{className:"excalidraw-wrapper",ref:t},React.createElement(ExcalidrawLib.Excalidraw,{ref:e,width:n.width,height:n.height,initialData:InitialData,viewModeEnabled:!0,zenModeEnabled:!0,gridModeEnabled:!1})))},excalidrawWrapper=document.getElementById("DDIA分享-04excalidraw.md4");ReactDOM.render(React.createElement(App),excalidrawWrapper);})();</script>

比如redis的哨兵模式就是 **复制**， 集群模式就是 **分区** + **复制**

## 分布式共识

> **共识** 是分布式计算中最重要也是最基本的问题之一。从表面上看似乎很简单：非正式地讲，目标只是 **让几个节点达成一致（get serveral nodes to agree on something）**

共识是分布式系统里面最终要的一个概念，本质上分布式系统的问题，都可以通过共识这种手段来解决，共识等于多个节点只能能达成一致，但是共识不一定能实现一致性，可以这么说，一致性是基于共识来实现的，一致性比共识更宽泛

### 共识的应用场景

共识不一定是用来实现强一致性的，他可以用在很多场景上，比如

#### 领导者选举

选举就是一个经典的共识场景，一个领导者必须被大部分节点认同(也就是达成共识)，他才能是领导者，否则如果达不成共识，就可能出现多个领导者，造成脑裂

#### 原子提交

分布式事务里面的原子提交，也必须让多个节点达成共识，要么都提交，要不都不提交

#### 区块链

前面提到的这些，称为 *传统分布式* 领域，这些领域一般是不需要考虑恶意节点的，不存在 [拜占庭将军](https://zh.m.wikipedia.org/zh-hans/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98) 问题

区块链比较特殊，除了解决传统的共识问题以外，还要解决其他问题，比如

1. 节点欺骗问题
2. 不存在中央控制方
3. 任何人都可能分叉，建立一条新链

所以区块链的分布式系统更复杂，以相对的低效率来换取公正，主流的公有链每秒只能处理几笔到几十笔交易

### 2PC与容错共识

书里讲了达成共识，需要满足以下几点

1. 一致同意（Uniform agreement）：没有两个节点的决定不同
2. 完整性（Integrity）: 没有节点决定两次
3. 有效性（Validity）: 如果一个节点决定了值 `v` ，则 `v` 由某个节点所提议
4. 终止（Termination）: 由所有未崩溃的节点来最终决定值

如果不关心容错，则满足前三点是很简单，比如2PC(2PC的流程就不展开了)就可以满足，只要由一个协调者节点说了算，但是，这样就无法保证容错能力，按书里的说法，*终止* 是活性属性，而其他几点是 *安全属性*

#### 常见的容错共识算法

- Paxos
- Raft
- Zab

#### 容错共识如何防止脑裂

容错共识跟2PC、单主复制这类不具备容错能力的共识系统相比，就是多了一个leader选举，让leader挂了之后，还可以选出新的leader来保证系统可用

问题就是新的leader跟老的leader如何达成共识，假如选出了新的leader，老的leader又"复活"了怎么办?

常规的解决方案是定义一个全局的序列号，书里翻译叫 **纪元编号**（epoch number，在 Paxos 中被称为 **投票编号**，即 ballot number，在视图戳复制中被称为 **视图编号**，即 view number，以及在 Raft 中被为 **任期号码**，即 term number)
因为纪元编号是全局递增的，如果发生了脑裂，则以编号更高的为准

在任何领导者被允许决定任何事情之前，必须先检查是否存在其他带有更高纪元编号的领导者

## 分布式一致性

分布式一致性，我们平常往往接触的是强一致性跟最终一致性，根据CAP里面，强一致性跟可用性只能二选一，所以大部分分布式框架，包括我们的业务实现，通常都会选择最终一致性

### 线性一致性

书里是这么定义线性一致性的，也就是不管实现细节，集群的行为看起来像是单台机器，就是线性一致性

> 线性一致性背后的基本思想很简单：使系统看起来好像只有一个数据副本

### 顺序一致性

顺序一致性是比线性一致性弱一个级别的一致性，它保证每个节点观察到的结果，都是有序的，但是不像线性一致性那样，能保证全局有序

比如下图这个例子，从全局顺序上看，P2读取的x应该是4，但是从p2自身来看，读取x为0也是保证顺序一致性的

![顺序一致性](data:image/png;base64,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)

这个图其实跟数据库隔离级别很像，并发情况下，RR跟RC都是对的，只是观察角度不一样，只要每个观察者(节点)自己能圆的过去就可以了，因为并发情况下的全局线性一致非常难保证(类型于事务隔离级别的串行化)

### 最终一致性

我们平常说的最终一致性，一般是说系统最终能达成一致，最终一致性是个非常弱的保证
举个例子，节点A修改了数据，并异步同步到B，C节点，但是C节点挂了没有同步到，这个时候系统是不一致的
但是后期人为修改C节点的数据，也是满足最终一致的

#### 读写一致性

最终一致性由于是异步的，虽然能保证数据最终趋于一致，但是中间过程中由于存在时间差，很可能会出现读写不一致问题，比如:

同一个客户端，向master节点A写入，由于同步是异步最终一致的，数据还没同步到C节点，这个时候从C节点就读不到数据

<div id="DDIA分享-05excalidraw.md5"></div><script>(function(){const InitialData={"type":"excalidraw","version":2,"source":"https://excalidraw.com","elements":[{"type":"ellipse","version":331,"versionNonce":162445509,"isDeleted":false,"id":"sNDSlWo4LHL4lCy3FPbHF","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-244.5654296875,"y":-182.9267578125,"strokeColor":"#000000","backgroundColor":"#fab005","width":80,"height":78,"seed":1398992741,"groupIds":[],"strokeSharpness":"sharp","boundElements":[{"type":"text","id":"K40dqlfg"},{"id":"KX1yu4TVZF7Sa4pya6Sbr","type":"arrow"},{"id":"fzydeR2CK2ycWXscIEhpp","type":"arrow"},{"id":"Tcx6Rii9vmqOvATWssCtc","type":"arrow"}],"updated":1671416879136,"link":null,"locked":false},{"type":"text","version":248,"versionNonce":944366091,"isDeleted":false,"id":"K40dqlfg","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-212.0654296875,"y":-156.4267578125,"strokeColor":"#000000","backgroundColor":"transparent","width":15,"height":25,"seed":1007805803,"groupIds":[],"strokeSharpness":"sharp","boundElements":null,"updated":1671416879136,"link":null,"locked":false,"fontSize":20,"fontFamily":1,"text":"A","rawText":"A","baseline":18,"textAlign":"center","verticalAlign":"middle","containerId":"sNDSlWo4LHL4lCy3FPbHF","originalText":"A"},{"type":"ellipse","version":470,"versionNonce":578493259,"isDeleted":false,"id":"rBxHj2NqDeQmqa2QYEupa","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-360.0712890625,"y":-17.5517578125,"strokeColor":"#000000","backgroundColor":"#82c91e","width":80,"height":78,"seed":846838469,"groupIds":[],"strokeSharpness":"sharp","boundElements":[{"type":"text","id":"RRkR710a"},{"id":"KX1yu4TVZF7Sa4pya6Sbr","type":"arrow"}],"updated":1671416879136,"link":null,"locked":false},{"type":"text","version":388,"versionNonce":718230245,"isDeleted":false,"id":"RRkR710a","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-328.5712890625,"y":8.9482421875,"strokeColor":"#000000","backgroundColor":"transparent","width":17,"height":25,"seed":388497419,"groupIds":[],"strokeSharpness":"sharp","boundElements":null,"updated":1671416879136,"link":null,"locked":false,"fontSize":20,"fontFamily":1,"text":"B","rawText":"B","baseline":18,"textAlign":"center","verticalAlign":"middle","containerId":"rBxHj2NqDeQmqa2QYEupa","originalText":"B"},{"type":"arrow","version":934,"versionNonce":1438222731,"isDeleted":false,"id":"KX1yu4TVZF7Sa4pya6Sbr","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-241.604999920098,"y":-110.87272077634326,"strokeColor":"#000000","backgroundColor":"transparent","width":68.79128573864003,"height":85.3956693339482,"seed":1331698213,"groupIds":[],"strokeSharpness":"round","boundElements":[{"type":"text","id":"fI7ka41C"}],"updated":1671416879141,"link":null,"locked":false,"startBinding":{"elementId":"sNDSlWo4LHL4lCy3FPbHF","focus":0.20471927423708247,"gap":10.093883466599308},"endBinding":{"elementId":"rBxHj2NqDeQmqa2QYEupa","focus":-0.5529808112929175,"gap":8.872635625401266},"lastCommittedPoint":null,"startArrowhead":null,"endArrowhead":"arrow","points":[[0,0],[-68.79128573864003,85.3956693339482]]},{"id":"fI7ka41C","type":"text","x":-317.000642789418,"y":-79.17488610936915,"width":82,"height":22,"angle":0,"strokeColor":"#000000","backgroundColor":"#ced4da","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"sharp","seed":1571425061,"version":57,"versionNonce":1981744267,"isDeleted":false,"boundElements":null,"updated":1671416879136,"link":null,"locked":false,"text":"复制完成","rawText":"复制完成","fontSize":20,"fontFamily":4,"textAlign":"center","verticalAlign":"middle","baseline":18,"containerId":"KX1yu4TVZF7Sa4pya6Sbr","originalText":"复制完成"},{"type":"arrow","version":1054,"versionNonce":1082531883,"isDeleted":false,"id":"fzydeR2CK2ycWXscIEhpp","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-174.41709847941485,"y":-104.0355385811767,"strokeColor":"#000000","backgroundColor":"transparent","width":45.270969128286175,"height":81.90586528999611,"seed":146790635,"groupIds":[],"strokeSharpness":"round","boundElements":[{"type":"text","id":"uJGDonF1"}],"updated":1671416879141,"link":null,"locked":false,"startBinding":{"elementId":"sNDSlWo4LHL4lCy3FPbHF","focus":-0.17825552493709304,"gap":10.645055091045286},"endBinding":{"elementId":"rhUskrCKrnsOwypCEgouQ","focus":0.3730997233695941,"gap":9.023825201088918},"lastCommittedPoint":null,"startArrowhead":null,"endArrowhead":"arrow","points":[[0,0],[45.270969128286175,81.90586528999611]]},{"id":"uJGDonF1","type":"text","x":-192.78161391527175,"y":-74.08260593617864,"width":82,"height":22,"angle":0,"strokeColor":"#000000","backgroundColor":"#ced4da","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"sharp","seed":1136803147,"version":55,"versionNonce":1283734315,"isDeleted":false,"boundElements":null,"updated":1671416879136,"link":null,"locked":false,"text":"复制延迟","rawText":"复制延迟","fontSize":20,"fontFamily":4,"textAlign":"center","verticalAlign":"middle","baseline":18,"containerId":"fzydeR2CK2ycWXscIEhpp","originalText":"复制延迟"},{"type":"ellipse","version":522,"versionNonce":1498456325,"isDeleted":false,"id":"rhUskrCKrnsOwypCEgouQ","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-160.01953125,"y":-13.9453125,"strokeColor":"#000000","backgroundColor":"#fa5252","width":80,"height":78,"seed":1032644325,"groupIds":[],"strokeSharpness":"sharp","boundElements":[{"type":"text","id":"GNQhOVPR"},{"id":"fzydeR2CK2ycWXscIEhpp","type":"arrow"},{"id":"sVscUix5nFE8I6WxjvT61","type":"arrow"}],"updated":1671416879136,"link":null,"locked":false},{"type":"text","version":436,"versionNonce":441032139,"isDeleted":false,"id":"GNQhOVPR","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-127.51953125,"y":12.5546875,"strokeColor":"#000000","backgroundColor":"transparent","width":15,"height":25,"seed":1531258347,"groupIds":[],"strokeSharpness":"sharp","boundElements":null,"updated":1671416879136,"link":null,"locked":false,"fontSize":20,"fontFamily":1,"text":"C","rawText":"C","baseline":18,"textAlign":"center","verticalAlign":"middle","containerId":"rhUskrCKrnsOwypCEgouQ","originalText":"C"},{"id":"QKMytKewEQw1DHnLizNOk","type":"rectangle","x":99.154296875,"y":-181.46875,"width":98,"height":62,"angle":0,"strokeColor":"#000000","backgroundColor":"#ced4da","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"sharp","seed":1113355397,"version":286,"versionNonce":763749317,"isDeleted":false,"boundElements":[{"type":"text","id":"CrkWrME3"},{"id":"Tcx6Rii9vmqOvATWssCtc","type":"arrow"},{"id":"sVscUix5nFE8I6WxjvT61","type":"arrow"}],"updated":1671416879136,"link":null,"locked":false},{"id":"CrkWrME3","type":"text","x":120.154296875,"y":-162.96875,"width":56,"height":25,"angle":0,"strokeColor":"#000000","backgroundColor":"#ced4da","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"sharp","seed":396917387,"version":238,"versionNonce":1091495691,"isDeleted":false,"boundElements":null,"updated":1671416879136,"link":null,"locked":false,"text":"Client","rawText":"Client","fontSize":20,"fontFamily":1,"textAlign":"center","verticalAlign":"middle","baseline":18,"containerId":"QKMytKewEQw1DHnLizNOk","originalText":"Client"},{"id":"Tcx6Rii9vmqOvATWssCtc","type":"arrow","x":90.5,"y":-147.65625,"width":247.45703125,"height":1.2109375,"angle":0,"strokeColor":"#000000","backgroundColor":"#ced4da","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"round","seed":182292037,"version":209,"versionNonce":1590092491,"isDeleted":false,"boundElements":[{"type":"text","id":"FlVPm6i4"}],"updated":1671416879142,"link":null,"locked":false,"points":[[0,0],[-247.45703125,-1.2109375]],"lastCommittedPoint":null,"startBinding":{"elementId":"QKMytKewEQw1DHnLizNOk","focus":-0.0990606381937879,"gap":8.654296875},"endBinding":{"elementId":"sNDSlWo4LHL4lCy3FPbHF","focus":-0.13264967898537958,"gap":7.875021683479048},"startArrowhead":null,"endArrowhead":"arrow"},{"id":"FlVPm6i4","type":"text","x":-54.228515625,"y":-159.26171875,"width":42,"height":22,"angle":0,"strokeColor":"#000000","backgroundColor":"#ced4da","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"sharp","seed":1290339691,"version":53,"versionNonce":662888523,"isDeleted":false,"boundElements":null,"updated":1671416879136,"link":null,"locked":false,"text":"写入","rawText":"写入","fontSize":20,"fontFamily":4,"textAlign":"center","verticalAlign":"middle","baseline":18,"containerId":"Tcx6Rii9vmqOvATWssCtc","originalText":"写入"},{"id":"sVscUix5nFE8I6WxjvT61","type":"arrow","x":128.375,"y":-111.7421875,"width":206.19140625,"height":117.515625,"angle":0,"strokeColor":"#000000","backgroundColor":"#ced4da","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"dashed","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"round","seed":369623627,"version":205,"versionNonce":152457579,"isDeleted":false,"boundElements":[{"type":"text","id":"ywcIP7FE"}],"updated":1671416879142,"link":null,"locked":false,"points":[[0,0],[-206.19140625,117.515625]],"lastCommittedPoint":null,"startBinding":{"elementId":"QKMytKewEQw1DHnLizNOk","focus":-0.46589424953969694,"gap":7.7265625},"endBinding":{"elementId":"rhUskrCKrnsOwypCEgouQ","focus":0.10563016777860271,"gap":6.576155645626336},"startArrowhead":null,"endArrowhead":"arrow"},{"id":"ywcIP7FE","type":"text","x":-35.720703125,"y":-63.984375,"width":122,"height":22,"angle":0,"strokeColor":"#000000","backgroundColor":"#ced4da","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"dashed","roughness":1,"opacity":100,"groupIds":[],"strokeSharpness":"sharp","seed":801304133,"version":61,"versionNonce":611753707,"isDeleted":false,"boundElements":null,"updated":1671416879136,"link":null,"locked":false,"text":"读取不到数据","rawText":"读取不到数据","fontSize":20,"fontFamily":4,"textAlign":"center","verticalAlign":"middle","baseline":18,"containerId":"sVscUix5nFE8I6WxjvT61","originalText":"读取不到数据"},{"type":"text","version":271,"versionNonce":566578315,"isDeleted":true,"id":"ylAcKtQo","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-293.3984375,"y":-84.0654296875,"strokeColor":"#000000","backgroundColor":"transparent","width":82,"height":22,"seed":1776404139,"groupIds":[],"strokeSharpness":"sharp","boundElements":null,"updated":1671416839174,"link":null,"locked":false,"fontSize":20,"fontFamily":4,"text":"复制完成","rawText":"复制完成","baseline":18,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"复制完成"},{"type":"text","version":250,"versionNonce":528400875,"isDeleted":true,"id":"sgyFJGns","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"angle":0,"x":-72.26171875,"y":-81.99609375,"strokeColor":"#000000","backgroundColor":"transparent","width":82,"height":22,"seed":1798445637,"groupIds":[],"strokeSharpness":"sharp","boundElements":null,"updated":1671416837903,"link":null,"locked":false,"fontSize":20,"fontFamily":4,"text":"复制延迟","rawText":"复制延迟","baseline":18,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"复制延迟"}],"appState":{"theme":"light","viewBackgroundColor":"#ffffff","currentItemStrokeColor":"#000000","currentItemBackgroundColor":"#ced4da","currentItemFillStyle":"hachure","currentItemStrokeWidth":1,"currentItemStrokeStyle":"dashed","currentItemRoughness":1,"currentItemOpacity":100,"currentItemFontFamily":4,"currentItemFontSize":20,"currentItemTextAlign":"left","currentItemStrokeSharpness":"sharp","currentItemStartArrowhead":null,"currentItemEndArrowhead":"arrow","scrollX":663.75,"scrollY":452.8671875,"zoom":{"value":1},"currentItemLinearStrokeSharpness":"round","gridSize":null,"colorPalette":{}},"files":{}};InitialData.scrollToContent=true;App=()=>{const e=React.useRef(null),t=React.useRef(null),[n,i]=React.useState({width:void 0,height:void 0});return React.useEffect(()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height});const e=()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height})};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[t]),React.createElement(React.Fragment,null,React.createElement("div",{className:"excalidraw-wrapper",ref:t},React.createElement(ExcalidrawLib.Excalidraw,{ref:e,width:n.width,height:n.height,initialData:InitialData,viewModeEnabled:!0,zenModeEnabled:!0,gridModeEnabled:!1})))},excalidrawWrapper=document.getElementById("DDIA分享-05excalidraw.md5");ReactDOM.render(React.createElement(App),excalidrawWrapper);})();</script>

**解决办法:**

1. **基于特殊的业务场景**，例如读自己从主库读，读别人从从库读
2. **设置时间阈值**，可以跟踪上次更新的时间，在上次更新后的一分钟内，从主库读。还可以监控从库的复制延迟，防止任向任何滞后超过一分钟到底从库发出查询
3. **设置时间戳**，确保从库为该用户提供任何查询时，该时间戳前的变更都已经传播到了本从库中。如果当前从库不够新，则可以从另一个从库读，或者等待从库追赶上来

#### 因果一致性

因果一致性是比顺序一致性弱的一致性，它保证数据的因果关系，但是不保证顺序，前面的读写一致性也属于因果一致性的一种

例如微信的朋友圈就是保证了因果一致性

### 总结

分布式一致性是个很大的话题，这里只是简单的介绍一下各个一致性概念和应用场景，具体的原理我也还在学习中
总体来说，CAP定理是个很绝对的定理，其中其实有很多文章可以做，比如etcd是CP系统，但是它可能做到半数节点宕机才挂掉，也具备高可用能力，所以一致性跟可用性不是非此即彼的，CAP其实很容易形成误导，所以后面也有人提出了BASE理论

具体应用哪种一致性模型，应该根据具体的业务需求来决定，因为越强的一致性保证，往往需要越多的代价


# 资料

- [Giahub上一份不错的开源翻译](https://github.com/Vonng/ddia)
- [木鸟杂记，个人觉得不错的一份笔记啊，缺点是后面几章没有](https://www.qtmuniao.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/DDIA/)
- [MIT 6.824 分布式系统](https://www.bilibili.com/video/BV1R7411t71W/)



